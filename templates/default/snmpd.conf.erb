# Generated by Chef on node <%= node['fqdn'] %>
# Local modifications will be overwritten.
###############################################################################
#
# snmpd.conf:
#   An example configuration file for configuring the ucd-snmp snmpd agent.
#
###############################################################################
#

agentAddress <%= node['snmp']['snmpd']['agentAddress'] %><% if node.key?('ip6address') -%>,<%= node['snmp']['snmpd']['agentAddress6'] %><% end -%>

###############################################################################
# Access Control
###############################################################################

####
# First, map the community string into a "security name"

#       sec.name  source          community
<% node['snmp']['snmpd']['sec_name'].each_pair do |sec_name, sources| %>
  <% sources.each do |source| %>
com2sec <%= sec_name %>  <%= source %>  <%= node['snmp']['snmpd']['community'] %>
  <% end %>
<% end %>

<% node['snmp']['snmpd']['sec_name6'].each_pair do |sec_name, sources| %>
  <% sources.each do |source| %>
com2sec6 <%= sec_name %>  <%= source %>  <%= node['snmp']['snmpd']['community'] %>
  <% end %>
<% end %>

####
# Second, map the security name into a group name:

#       groupName      securityModel sec.name
<% node['snmp']['snmpd']['groups']['v1'].each_pair do |group, sec_names| %>
  <% sec_names.each do |sec_name| %>
group <%= group %>  v1  <%= sec_name %>
  <% end %>
<% end %>

<% node['snmp']['snmpd']['groups']['v2c'].each_pair do |group, sec_names| %>
  <% sec_names.each do |sec_name| %>
group <%= group %>  v2c  <%= sec_name %>
  <% end %>
<% end %>

####
# Third, create a view for us to let the group have rights to:

# Make at least  snmpwalk -v 1 localhost -c public system fast again.
#       name           incl/excl     subtree         mask(optional)
<% if node['snmp']['snmpd']['full_systemview'] %>
view    systemview    included   .1
<% end -%>
<% additional_oids = node['snmp']['snmpd']['additional_oids'].kind_of?(Array) ? node['snmp']['snmpd']['additional_oids'] : [ node['snmp']['snmpd']['additional_subtrees'] ] -%>
<% unless additional_oids.empty? %>
  <% additional_oids.each do |oid| -%>
view    systemview    included   <%= oid %>
  <% end -%>
<% end %>
view    systemview    included   .1.3.6.1.2.1.1
view    systemview    included   .1.3.6.1.2.1.25.1.1

####
# Finally, grant the group read-only access to the systemview view.

#       group          context sec.model sec.level prefix read   write  notif
<% unless @groups.empty? %>
  <% @groups.each do |group| %>
access  <%= group %> ""      any       noauth    exact  systemview none none
  <% end %>
<% end %>

###############################################################################
# System contact information
#

# It is also possible to set the sysContact and sysLocation system
# variables through the snmpd.conf file:

<% if node['virtualization']['role'] == 'guest' %>
syslocation <%= node['snmp']['snmpd']['syslocationVirtual'] %>
<% else %>
syslocation <%= node['snmp']['snmpd']['syslocationPhysical'] %>
<% end %>
syscontact <%= node['snmp']['snmpd']['syscontact'] %>
sysName <%= node['snmp']['snmpd']['sysname'] %>

# Pass-through scripts, if any:
pass .1.3.6.1.4.1.4413.4.1 /usr/bin/ucd5820stat # Added for support of bcm5820 cards.
<% unless node['snmp']['snmpd']['pass'].empty? %>
  <% node['snmp']['snmpd']['pass'].each do |oid, cmd| %>
pass <%= oid %> <%= cmd %>
  <% end %>
<% end %>

<% unless node['snmp']['snmpd']['pass_persist'].empty? %>
  <% node['snmp']['snmpd']['pass_persist'].each do |oid, cmd| %>
pass_persist <%= oid %> <%= cmd %>
  <% end %>
<% end %>

<% if node.key?('dmi') && node['dmi'].key?('system') && node['dmi']['system'].key?('manufacturer') && node['dmi']['system']['manufacturer'] =~ /dell/i %>
# Allow Systems Management Data Engine SNMP to connect to snmpd using SMUX
smuxpeer .1.3.6.1.4.1.674.10892.1
<% end %>

<% if ::File.exists?("/usr/lib64/libcmaX64.so") %>
# Needed for HP System Management Homepage if shared object exists
dlmod cmaX /usr/lib64/libcmaX64.so
rocommunity <%= node['snmp']['snmpd']['community'] %> 127.0.0.1
<% end %>

###############################################################################
# Logging
#
# We do not want annoying "Connection from UDP: " messages in syslog.
# If the following option is commented out, snmpd will print each incoming
# connection, which can be useful for debugging.

<% if node.read('snmp', 'dontLogTCPWrappersConnects') %>
dontLogTCPWrappersConnects <%= node['snmp']['dontLogTCPWrappersConnects'] %>
<% end %>

###############################################################################
# Process monitoring
#
#  See the snmpd.conf manual page, and the output of "snmpd -H".
<% unless node['snmp']['snmpd']['process_monitoring']['proc'].empty? %>
  <% node['snmp']['snmpd']['process_monitoring']['proc'].each do |proc_entry| %>
proc <%= proc_entry %>
  <% end %>
<% end %>

<% unless node['snmp']['snmpd']['process_monitoring']['procfix'].empty? %>
  <% node['snmp']['snmpd']['process_monitoring']['procfix'].each do |procfix_entry| %>
procfix <%= procfix_entry %>
  <% end %>
<% end %>

# Disk Checks
#
# 
# When compiled with the ucd-snmp/disk module (included by default),
# the snmp agent can check the amount of available disk space and
# make sure it is above a set limit.

<% if node['snmp']['snmpd']['include_all_disks'] %>
includeAllDisks <%= node['snmp']['snmpd']['all_disk_min'] %>
<% end %>
<% unless node['snmp']['snmpd']['disks'].empty? %>
  <% node['snmp']['snmpd']['disks'].each do |disk| %>
disk <%= disk['mount'] %> <%= disk['min'] %>
  <% end %>
<% end %>
<% unless node['snmp']['snmpd']['ignoredisks'].empty? %>
  <% node['snmp']['snmpd']['ignoredisks'].each do |disk| %>
ignoredisk <%= disk %>
  <% end %>
<% end %>
<% if defined?(node['snmp']['snmpd']['skipNFSInHostResources']) %>
  <% unless node['snmp']['snmpd']['skipNFSInHostResources'].nil? -%>
    <% if node['snmp']['snmpd']['skipNFSInHostResources'] == true %>
skipNFSInHostResources true
    <% else %>
skipNFSInHostResources false
    <% end %>
  <% end %>
<% end %>

# Load Average Checks
#
# load [1MAX=DEFMAXLOADAVE] [5MAX=DEFMAXLOADAVE] [15MAX=DEFMAXLOADAVE]
#
# 1MAX:   If the 1 minute load average is above this limit at query
#         time, the errorFlag will be set.
# 5MAX:   Similar, but for 5 min average.
# 15MAX:  Similar, but for 15 min average.

<% unless node['snmp']['snmpd']['load_average'].empty? -%>
  <% load = node['snmp']['snmpd']['load_average'] %>
load <%= load['max1'] %> <%= load['max5'] %> <%= load['max15'] %>
<% end %>

###############################################################################
# Trap communities and trapsinks
#
#  See the snmpd.conf manual page, and the output of "snmpd -H".
trapcommunity <%= node['snmp']['snmptrapd']['trapcommunity'] %>

<% unless node['snmp']['snmpd']['trapsinks'].empty? %>
  <% node['snmp']['snmpd']['trapsinks'].each do |trapsink| %>
trapsink <%= trapsink %>
  <% end %>
<% end %>

<% if node['snmp']['snmptrapd']['trapd_run'] == "yes" %>
master agentx
<% end %>

###############################################################################
# Extend Section
#
#
<% unless node['snmp']['snmpd']['extend_scripts'].empty? %>
  <% node['snmp']['snmpd']['extend_scripts'].each do |name, cmd| %>
extend <%= name %> <%= cmd %>
  <% end %>
<% end %>

<% if node['snmp']['snmpd']['disman_events']['enable'] %>
###############################################################################
# DisMan Event MIB
#
#  See the snmpd.conf manual page.

createUser <%= node['snmp']['snmpd']['disman_events']['user'] %> MD5 <%= node['snmp']['snmpd']['disman_events']['password'] %>
rouser <%= node['snmp']['snmpd']['disman_events']['user'] %> auth
agentSecName <%= node['snmp']['snmpd']['disman_events']['user'] %>
linkUpDownNotifications <%= node['snmp']['snmpd']['disman_events']['linkUpDownNotifications'] %>
defaultMonitors <%= node['snmp']['snmpd']['disman_events']['defaultMonitors'] %>
  <% unless node['snmp']['snmpd']['disman_events']['monitors'].empty? %>
    <% node['snmp']['snmpd']['disman_events']['monitors'].each do |monitor_entry| %>
monitor <%= monitor_entry %>
    <% end %>
  <% end %>
<% end %>
